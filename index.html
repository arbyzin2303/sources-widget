<!--
	amocrm_period — GET-параметр, отвечающий за выбранный период на рабочем столе в amoCRM
	возможные значения: day / week / month
-->

<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Источники заявок — amoCRM Dashboard Widget</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&family=Open+Sans:wght@300;400;600&display=swap">
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

	<style>
	* {
		-webkit-box-sizing: border-box;
		-moz-box-sizing: border-box;
		box-sizing: border-box;
		text-rendering: geometricPrecision;
		-webkit-font-smoothing: antialiased;
		margin: 0;
		padding: 0;
	}
	html, body {
		font-family: 'PT Sans', sans-serif;
		color: #2E3640;
		background: #fff;
		height: 100%;
		overflow: hidden;
	}

	.widget {
		padding: 20px 15px 15px 15px;
		height: 100%;
		display: flex;
		flex-direction: column;
	}

	.widget__header {
		display: flex;
		justify-content: space-between;
		align-items: baseline;
		margin-bottom: 14px;
	}
	.widget__title {
		font-size: 15px;
		font-weight: bold;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
	.widget__period {
		font-size: 12px;
		color: #9BA6B2;
		font-family: 'Open Sans', sans-serif;
		white-space: nowrap;
		margin-left: 8px;
		flex-shrink: 0;
	}

	.widget__body {
		flex: 1;
		display: flex;
		align-items: center;
		gap: 18px;
		min-height: 0;
	}

	.chart-area {
		position: relative;
		flex-shrink: 0;
		width: 136px;
		height: 136px;
	}
	.chart-area canvas {
		width: 100% !important;
		height: 100% !important;
	}
	.chart-center {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		text-align: center;
		pointer-events: none;
	}
	.chart-center__count {
		font-size: 26px;
		font-weight: 300;
		font-family: 'Open Sans', sans-serif;
		line-height: 1.1;
		color: #2E3640;
	}
	.chart-center__label {
		font-size: 11px;
		color: #9BA6B2;
		font-family: 'Open Sans', sans-serif;
		margin-top: 1px;
	}

	.legend {
		flex: 1;
		min-width: 0;
		overflow-y: auto;
		max-height: 100%;
	}
	.legend::-webkit-scrollbar {
		width: 3px;
	}
	.legend::-webkit-scrollbar-thumb {
		background: #D5D8DB;
		border-radius: 3px;
	}

	.legend__item {
		display: flex;
		align-items: center;
		padding: 5px 0;
		font-size: 13px;
		font-family: 'Open Sans', sans-serif;
		line-height: 1.3;
	}
	.legend__dot {
		width: 10px;
		height: 10px;
		border-radius: 50%;
		flex-shrink: 0;
		margin-right: 8px;
	}
	.legend__label {
		flex: 1;
		min-width: 0;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		color: #5E6C84;
	}
	.legend__value {
		font-weight: 600;
		color: #2E3640;
		margin-left: 10px;
		white-space: nowrap;
	}
	.legend__pct {
		color: #9BA6B2;
		font-size: 11px;
		margin-left: 4px;
		white-space: nowrap;
		min-width: 32px;
		text-align: right;
	}

	.no-data {
		display: flex;
		align-items: center;
		justify-content: center;
		flex: 1;
		color: #9BA6B2;
		font-size: 14px;
		font-family: 'Open Sans', sans-serif;
	}

	@media (max-width: 320px) {
		.widget__body { flex-direction: column; gap: 10px; }
		.chart-area { width: 110px; height: 110px; }
		.chart-center__count { font-size: 20px; }
	}
	</style>
</head>
<body>

<div class="widget" id="widget">
	<div class="widget__header">
		<div class="widget__title">Источники заявок</div>
		<div class="widget__period" id="periodLabel"></div>
	</div>

	<div class="widget__body">
		<div class="chart-area">
			<canvas id="chart"></canvas>
			<div class="chart-center">
				<div class="chart-center__count" id="totalCount">0</div>
				<div class="chart-center__label">заявок</div>
			</div>
		</div>
		<div class="legend" id="legend"></div>
	</div>
</div>

<script>
(function() {
	'use strict';

	var SOURCE_COLORS = {
		'Я Директ':     '#FFCA28',
		'Сайт':         '#42A5F5',
		'Агрегаторы':   '#AB47BC',
		'Яндекс карты': '#FF7043',
		'Гугл карты':   '#66BB6A',
		'2 ГИС':        '#29B6F6',
		'Интерфейс':    '#78909C',
		'Форма':        '#26A69A',
		'API':          '#8D6E63',
		'Другое':       '#BDBDBD'
	};

	var FALLBACK_COLORS = [
		'#EF5350', '#EC407A', '#7E57C2', '#5C6BC0',
		'#26A69A', '#8D6E63', '#78909C', '#D4E157'
	];

	var PERIOD_LABELS = {
		day:   'за сегодня',
		week:  'за неделю',
		month: 'за месяц'
	};

	var chartInstance = null;

	function getParam(name) {
		var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
		return match ? decodeURIComponent(match[1]) : null;
	}

	function getPeriod() {
		return getParam('amocrm_period') || 'week';
	}

	function getColorForSource(name, index) {
		if (SOURCE_COLORS[name]) return SOURCE_COLORS[name];
		return FALLBACK_COLORS[index % FALLBACK_COLORS.length];
	}

	function renderPeriod() {
		var period = getPeriod();
		var label = PERIOD_LABELS[period] || PERIOD_LABELS.week;
		document.getElementById('periodLabel').textContent = label;
	}

	function renderChart(data) {
		var labels = [];
		var values = [];
		var colors = [];
		var total = 0;

		for (var i = 0; i < data.length; i++) {
			labels.push(data[i].name);
			values.push(data[i].count);
			colors.push(getColorForSource(data[i].name, i));
			total += data[i].count;
		}

		document.getElementById('totalCount').textContent = total;

		var legendEl = document.getElementById('legend');
		var legendHtml = '';
		for (var j = 0; j < data.length; j++) {
			var pct = total > 0 ? Math.round(data[j].count / total * 100) : 0;
			legendHtml +=
				'<div class="legend__item">' +
					'<span class="legend__dot" style="background:' + colors[j] + '"></span>' +
					'<span class="legend__label" title="' + data[j].name + '">' + data[j].name + '</span>' +
					'<span class="legend__value">' + data[j].count + '</span>' +
					'<span class="legend__pct">' + pct + '%</span>' +
				'</div>';
		}
		legendEl.innerHTML = legendHtml;

		var canvas = document.getElementById('chart');
		var ctx = canvas.getContext('2d');

		if (chartInstance) {
			chartInstance.destroy();
		}

		chartInstance = new Chart(ctx, {
			type: 'doughnut',
			data: {
				labels: labels,
				datasets: [{
					data: values,
					backgroundColor: colors,
					borderWidth: 2,
					borderColor: '#ffffff',
					hoverBorderColor: '#ffffff',
					hoverBorderWidth: 3,
					hoverOffset: 6
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				cutout: '62%',
				plugins: {
					legend: { display: false },
					tooltip: {
						backgroundColor: '#2E3640',
						titleFont: { family: 'PT Sans', size: 13 },
						bodyFont: { family: 'Open Sans', size: 12 },
						cornerRadius: 6,
						padding: 10,
						callbacks: {
							label: function(ctx) {
								var t = 0;
								ctx.dataset.data.forEach(function(v) { t += v; });
								var p = t > 0 ? Math.round(ctx.parsed / t * 100) : 0;
								return ' ' + ctx.label + ': ' + ctx.parsed + ' (' + p + '%)';
							}
						}
					}
				},
				animation: {
					animateRotate: true,
					duration: 800,
					easing: 'easeOutQuart'
				}
			}
		});
	}

	function showNoData() {
		document.querySelector('.widget__body').innerHTML =
			'<div class="no-data">Нет данных за выбранный период</div>';
	}

	// --- Data sources ---

	function getDemoData() {
		return [
			{ name: 'Я Директ',     count: 45 },
			{ name: 'Сайт',         count: 32 },
			{ name: 'Агрегаторы',   count: 28 },
			{ name: 'Яндекс карты', count: 22 },
			{ name: 'Гугл карты',   count: 18 },
			{ name: '2 ГИС',        count: 11 }
		];
	}

	function init() {
		renderPeriod();

		var urlData = getParam('data');
		if (urlData) {
			try {
				var parsed = JSON.parse(urlData);
				if (Array.isArray(parsed) && parsed.length > 0) {
					renderChart(parsed);
					return;
				}
			} catch(e) {}
		}

		renderChart(getDemoData());
	}

	// Accept real-time data from the amoCRM widget via postMessage
	window.addEventListener('message', function(event) {
		if (!event.data) return;

		var msg = event.data;
		if (msg.type === 'sources_data' && Array.isArray(msg.data)) {
			renderChart(msg.data);
		}
		if (msg.type === 'sources_period' && msg.period) {
			var label = PERIOD_LABELS[msg.period] || PERIOD_LABELS.week;
			document.getElementById('periodLabel').textContent = label;
		}
	});

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
})();
</script>

</body>
</html>
